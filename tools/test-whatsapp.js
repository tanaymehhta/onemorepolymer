#!/usr/bin/env node

/**
 * WhatsApp Integration Test Script
 * Tests the WhatsApp service configuration and message generation
 */

console.log('🚀 Testing WhatsApp Integration...\n')

// Test 1: Environment Configuration
console.log('1. Testing Environment Configuration')
const requiredVars = [
  'WHATSAPP_API_TOKEN',
  'WHATSAPP_API_URL',
  'WHATSAPP_PHONE_NUMBER_ID',
  'WHATSAPP_PHONE_ACCOUNTS',
  'WHATSAPP_PHONE_LOGISTICS',
  'WHATSAPP_PHONE_BOSS1',
  'WHATSAPP_PHONE_BOSSOG'
]

const missingVars = requiredVars.filter(varName => !process.env[varName])

if (missingVars.length === 0) {
  console.log('✅ All required environment variables are set')
} else {
  console.log('❌ Missing environment variables:', missingVars.join(', '))
  console.log('💡 Check your .env.local file')
}

// Test 2: Feature Flags
console.log('\n2. Testing Feature Flags')
const featureFlags = {
  'FEATURE_WHATSAPP_MESSAGING': process.env.FEATURE_WHATSAPP_MESSAGING,
  'WHATSAPP_RATE_LIMIT_ENABLED': process.env.WHATSAPP_RATE_LIMIT_ENABLED,
  'WHATSAPP_RETRY_ENABLED': process.env.WHATSAPP_RETRY_ENABLED
}

Object.entries(featureFlags).forEach(([flag, value]) => {
  const status = value === 'true' ? '✅ ENABLED' : '⚠️  DISABLED'
  console.log(`${flag}: ${status}`)
})

// Test 3: Sample Deal Data
console.log('\n3. Sample Deal Data for Testing')
const sampleDeal = {
  id: 'TEST-001',
  date: new Date().toISOString().split('T')[0],
  saleParty: 'Test Customer Ltd',
  quantitySold: 1000,
  saleRate: 85,
  deliveryTerms: 'delivered',
  productCode: 'PP-001',
  product: 'Polypropylene',
  grade: 'H110MA',
  company: 'Test Industries',
  materialSource: 'new-material',
  purchaseParty: 'Test Supplier',
  quantityPurchased: 1000,
  purchaseRate: 80,
  saleComments: 'This is a test deal for WhatsApp integration',
  finalComments: 'Generated by test script'
}

console.log('Sample deal created:', JSON.stringify(sampleDeal, null, 2))

// Test 4: API Endpoints
console.log('\n4. Available API Endpoints')
const endpoints = [
  'GET  /api/messaging/status        - Service health check',
  'GET  /api/messaging/validate-config - Configuration validation',
  'POST /api/messaging/test          - Send test message',
  'POST /api/messaging/preview       - Generate message previews',
  'POST /api/deals                   - Create deal with WhatsApp notifications'
]

endpoints.forEach(endpoint => console.log(`📡 ${endpoint}`))

// Test 5: Next Steps
console.log('\n5. Next Steps for Testing')
console.log('🔧 Start the development server: npm run dev')
console.log('🧪 Test configuration: curl http://localhost:3000/api/messaging/validate-config')
console.log('💬 Send test message: POST to http://localhost:3000/api/messaging/test')
console.log('📋 Preview messages: POST to http://localhost:3000/api/messaging/preview')
console.log('🎯 Create test deal: POST to http://localhost:3000/api/deals')

console.log('\n✨ WhatsApp Integration Setup Complete!')
console.log('📚 Check WHATSAPP-DEVELOPMENT.md for detailed documentation')